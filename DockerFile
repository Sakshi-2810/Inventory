# ---------- STAGE 1: Build ----------
FROM maven:3.9.6-eclipse-temurin-17 AS build
WORKDIR /app

# Copy pom and download dependencies offline
COPY pom.xml .
RUN mvn dependency:go-offline

# Copy source code and build
COPY src ./src
RUN mvn clean package -DskipTests


# ---------- STAGE 2: Runtime ----------
# Use Playwright official image (Ubuntu Focal) with all dependencies
FROM mcr.microsoft.com/playwright:focal AS runtime
WORKDIR /app

# ðŸ”¹ Prevent Playwright from deleting browsers
ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright

# ðŸ”¹ Preinstall browsers once during image build (theyâ€™ll stay cached)
RUN npx playwright install --with-deps chromium

# Install OpenJDK 17 + Fonts for Hindi/Devanagari + clean up
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        openjdk-17-jdk-headless \
        fonts-noto-core \
        fonts-noto-extra \
        fonts-noto-unhinted \
        fonts-noto-cjk \
        fonts-noto-color-emoji \
        locales && \
    rm -rf /var/lib/apt/lists/*

# Set locale for Hindi
RUN locale-gen hi_IN.UTF-8
ENV LANG=hi_IN.UTF-8
ENV LANGUAGE=hi_IN:hi
ENV LC_ALL=hi_IN.UTF-8

# Copy Spring Boot jar from build stage
COPY --from=build /app/target/*.jar app.jar

# ðŸ”¹ (Optional but recommended) â€” mark browsers folder as a Docker volume
VOLUME ["/ms-playwright"]

# Run the Spring Boot application
ENTRYPOINT ["java", "-XX:+UseContainerSupport", "-XX:MaxRAMPercentage=75", "-jar", "app.jar"]
