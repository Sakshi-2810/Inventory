<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice Dashboard</title>
  <link rel="icon" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="18" fill="%23345"/><text x="50" y="57" font-size="48" text-anchor="middle" fill="white" font-family="Arial, Helvetica, sans-serif">I D</text></svg>'>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

<div class="container py-5">
<div style="margin-bottom:12px;">
        <button class="btn btn-home" onclick="goHome()">üè† Home</button>
    </div>
  <h1 class="text-center mb-5 text-primary">üìä Invoice Dashboard</h1>

  <!-- Filters -->
  <div class="row g-3 justify-content-center mb-4">
    <div class="col-auto">
      <label for="fromDate" class="form-label">From Date</label>
      <input type="date" id="fromDate" class="form-control">
    </div>
    <div class="col-auto">
      <label for="toDate" class="form-label">To Date</label>
      <input type="date" id="toDate" class="form-control">
    </div>
   <div class="col-auto align-self-end">
    <button id="filterBtn" class="btn btn-primary position-relative">
        <span class="spinner-border spinner-border-sm me-2 d-none" id="filterSpinner" role="status"></span>
        <span id="filterBtnText">Apply Filter</span>
    </button>
    </div>  

  </div>

  <!-- KPI Row -->
  <div class="row text-center mb-5">
    <div class="col-md-3 mb-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="text-muted">Total Sales</h6>
          <p id="totalSales" class="h5 text-success mb-0">‚Çπ0</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="text-muted">Total Purchases</h6>
          <p id="totalPurchases" class="h5 text-danger mb-0">‚Çπ0</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="text-muted">Total Due</h6>
          <p id="totalDue" class="h5 text-warning mb-0">‚Çπ0</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="text-muted">Average Invoice</h6>
          <p id="avgInvoice" class="h5 text-primary mb-0">‚Çπ0</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row mb-5">
    
    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="card-title">üèÜ Top Parties by Value</h6>
          <canvas id="partyChart" height="150"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
  <div class="card shadow-sm">
    <div class="card-body">
      <h6 class="card-title">üìà Top Stocks by Value</h6>
      <canvas id="stockChart" height="150"></canvas>
    </div>
  </div>
</div>
<div class="col-lg-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="card-title">üìÖ Monthly Sales Overview</h6>
          <canvas id="salesChart" height="150"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Invoice Table -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h6 class="card-title mb-3">üìú Invoice Details</h6>
       <!-- Search -->
    <div class="mb-3">
      <input type="text" id="invoiceSearch" class="form-control" placeholder="Search by Party or Type">
    </div>

      <div class="table-responsive">
        <table class="table table-striped table-bordered mb-0">
          <thead class="table-light text-center">
            <tr>
              <th>#</th>
              <th>Date</th>
              <th>Party</th>
              <th>Type</th>
              <th>Total</th>
              <th>Due</th>
            </tr>
          </thead>
          <tbody id="invoiceTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
  const apiUrl = "/dashboard";

  let salesChart, partyChart, stockChart;
  const salesCtx = document.getElementById("salesChart").getContext("2d");
  const partyCtx = document.getElementById("partyChart").getContext("2d");
  const stockCtx = document.getElementById("stockChart").getContext("2d");
function goHome() { window.location.href='/index.html'; }

  function toDisplayFormat(yyyymmdd) {
    const [yyyy, mm, dd] = yyyymmdd.split('-');
    return `${dd}-${mm}-${yyyy}`;
  }
  function toInputDateFormat(ddmmyyyy) {
    const [dd, mm, yyyy] = ddmmyyyy.split('-');
    return `${yyyy}-${mm}-${dd}`;
  }

  function getCurrentMonthRange() {
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const firstDay = `${yyyy}-${mm}-01`;
    const lastDayDate = new Date(yyyy, now.getMonth() + 1, 0);
    const lastDay = `${yyyy}-${mm}-${String(lastDayDate.getDate()).padStart(2,'0')}`;
    return { firstDay, lastDay };
  }

  async function fetchDashboardData(fromDate, toDate) {
    try {
      const res = await fetch(`${apiUrl}?fromDate=${fromDate}&toDate=${toDate}`);
      const data = await res.json();
      let invoices = data.data.invoice || [];
      const topParties = data.data.party || [];
      invoices = invoices.map(inv => {
        if (inv.date) inv.dateObj = toInputDateFormat(inv.date);
        return inv;
      });
      updateKPIs(invoices);
      updateCharts(invoices, topParties);
      updateTable(invoices);
    } catch (err) {
      console.error(err);
      alert("Failed to load dashboard data.");
    }
  }
const invoiceSearch = document.getElementById('invoiceSearch');

invoiceSearch.addEventListener('input', () => {
  const filter = invoiceSearch.value.toLowerCase();
  const rows = document.querySelectorAll('#invoiceTableBody tr');

  rows.forEach(row => {
    const party = row.cells[2].textContent.toLowerCase();
    const type = row.cells[3].textContent.toLowerCase();

    if(party.includes(filter) || type.includes(filter)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
});

  function updateKPIs(invoices) {
    const totalSales = invoices.filter(i => i.transactionType === "SELL").reduce((s,i)=>s+(i.totalCost||0),0);
    const totalPurchases = invoices.filter(i => i.transactionType === "BUY").reduce((s,i)=>s+(i.totalCost||0),0);
    const totalDue = invoices.reduce((s,i)=>s+(i.dueAmount||0),0);
    const avgInvoice = invoices.length ? (invoices.reduce((s,i)=>s+(i.totalCost||0),0)/invoices.length).toFixed(0) : 0;

    document.getElementById("totalSales").textContent = `‚Çπ${totalSales.toLocaleString()}`;
    document.getElementById("totalPurchases").textContent = `‚Çπ${totalPurchases.toLocaleString()}`;
    document.getElementById("totalDue").textContent = `‚Çπ${totalDue.toLocaleString()}`;
    document.getElementById("avgInvoice").textContent = `‚Çπ${Number(avgInvoice).toLocaleString()}`;
  }
function filterTableByParty(partyName) {
  const rows = document.querySelectorAll('#invoiceTableBody tr');
  let firstVisibleRow = null;

  rows.forEach(row => {
    const partyCell = row.cells[2].textContent;
    if(partyCell === partyName) {
      row.style.display = '';
      if(!firstVisibleRow) firstVisibleRow = row;
    } else {
      row.style.display = 'none';
    }
  });

  if(firstVisibleRow){
    firstVisibleRow.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function updateCharts(invoices, parties) {
  // Monthly sales (same as before)
  const monthlyData = {};
  invoices.forEach(i=>{
    const month = i.dateObj ? new Date(i.dateObj).toLocaleString('default',{month:'short'}) : 'Unknown';
    monthlyData[month] = (monthlyData[month]||0)+(i.totalCost||0);
  });
  const monthLabels = Object.keys(monthlyData);
  const monthValues = Object.values(monthlyData);

  // Update salesChart creation with onClick
if(salesChart) salesChart.destroy();
salesChart = new Chart(salesCtx, {
  type:'bar',
  data:{
    labels: monthLabels,
    datasets:[{
      label:'Total Sales (‚Çπ)',
      data: monthValues,
      backgroundColor:'rgba(37,99,235,0.6)',
      borderColor:'rgba(37,99,235,1)',
      borderWidth:1
    }]
  },
  options:{
    responsive:true,
    scales:{ y:{ beginAtZero:true } },
    onClick: (evt, elements) => {
      if(elements.length > 0){
        const index = elements[0].index;
        const monthLabel = monthLabels[index]; // e.g., "Jan", "Feb"

        // Scroll to invoice table
        const tableSection = document.getElementById('invoiceTableBody');
        tableSection.scrollIntoView({ behavior: 'smooth' });

        // Optional: filter invoices for selected month
        const filteredInvoices = invoices.filter(inv => {
          const invMonth = new Date(toInputDateFormat(inv.date)).toLocaleString('default', { month:'short' });
          return invMonth === monthLabel;
        });
        updateTable(filteredInvoices);
      }
    }
  }
});

  // Party Chart
  const partyColors = parties.map((_,i)=>`hsl(${i*360/parties.length},70%,50%)`);
 if(partyChart) partyChart.destroy();
partyChart = new Chart(partyCtx, {
  type: 'pie',
  data: {
    labels: parties.map(p => p.name),
    datasets: [{
      data: parties.map(p => p.totalCost),
      backgroundColor: partyColors
    }]
  },
  options: {
    responsive: true,
    onClick: (evt, elements) => {
      if(elements.length > 0){
        const idx = elements[0].index;
        const partyName = parties[idx].name;
        filterTableByParty(partyName);
      }
    }
  }
});


  // Top Stocks Chart (aggregate by stock/item name)
 // Aggregate quantities per stock
const stockData = {};
invoices.forEach(inv => {
  if (inv.stockBills && Array.isArray(inv.stockBills)) {
    inv.stockBills.forEach(item => {
      const key = item.itemName || 'Unknown';
      const unit = item.unit || '';
      if (!stockData[key]) {
        stockData[key] = { quantity: 0, unit: unit };
      }
      stockData[key].quantity += item.quantity || 0;
    });
  }
});

// Sort by quantity descending and take top 10
const sortedStocks = Object.entries(stockData)
  .sort((a, b) => b[1].quantity - a[1].quantity)
  .slice(0, 10);

// Labels and values for chart
const stockLabels = sortedStocks.map(s => s[0]);
const stockValues = sortedStocks.map(s => s[1].quantity);

// Generate colors
const stockColors = stockLabels.map((_, i) => `hsl(${i * 360 / stockLabels.length}, 70%, 60%)`);

// Destroy existing chart if present
if (stockChart) stockChart.destroy();

// Create chart
stockChart = new Chart(stockCtx, {
  type: 'pie',
  data: {
    labels: stockLabels,
    datasets: [{
      data: stockValues,
      backgroundColor: stockColors
    }]
  },
  options: {
    responsive: true,
    plugins: {
      tooltip: {
        callbacks: {
          label: function(context) {
            const key = context.label;
            const item = stockData[key];
            return `${key}: ${item.quantity} ${item.unit}`;
          }
        }
      }
    }
  }
});
}

function updateTable(invoices) {
  const tbody = document.getElementById('invoiceTableBody');
  tbody.innerHTML = '';
  
  invoices.forEach(i => {
    const row = document.createElement('tr');
    row.style.cursor = 'pointer'; // show pointer on hover
    row.setAttribute('data-id', i.id); // assuming invoice object has an 'id' field

    row.innerHTML = `
      <td>${i.invoiceId}</td>
      <td>${i.date}</td>
      <td>${i.partyName || '-'}</td>
      <td>${i.transactionType}</td>
      <td class="text-end">‚Çπ${i.totalCost || 0}</td>
      <td class="text-end">‚Çπ${i.dueAmount || 0}</td>
    `;

    // Attach click event to row
    row.addEventListener('click', () => viewInvoice(i.invoiceId));

    tbody.appendChild(row);
  });
}


  document.getElementById('filterBtn').addEventListener('click',async()=>{
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    if(!fromDate||!toDate){ alert('Select both dates!'); return;}

    const spinner = document.getElementById('filterSpinner');
    const btnText = document.getElementById('filterBtnText');

    // Show spinner
    spinner.classList.remove('d-none');
    btnText.textContent = 'Loading...';
    document.getElementById('filterBtn').disabled = true;
        try {
        await fetchDashboardData(toDisplayFormat(fromDate), toDisplayFormat(toDate));
    } catch (err) {
        console.error(err);
        alert('Failed to load data.');
    } finally {
        // Hide spinner
        spinner.classList.add('d-none');
        btnText.textContent = 'Apply Filter';
        document.getElementById('filterBtn').disabled = false;
    }
});

  // Auto load current month
  window.addEventListener('DOMContentLoaded',async()=>{
    const {firstDay,lastDay} = getCurrentMonthRange();
    document.getElementById('fromDate').value = firstDay;
    document.getElementById('toDate').value = lastDay;
    await fetchDashboardData(toDisplayFormat(firstDay), toDisplayFormat(lastDay));
  });
 function viewInvoice(id) {
      window.location.href = `viewSingleInvoice.html?id=${id}`;
    }
</script>

</body>
</html>
