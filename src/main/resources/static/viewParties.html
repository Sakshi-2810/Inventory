<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>View Parties</title>
    <link rel="icon" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="18" fill="%23345"/><text x="50" y="57" font-size="48" text-anchor="middle" fill="white" font-family="Arial, Helvetica, sans-serif">P</text></svg>'>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Modern Ledger Table Styles */
.ledger-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: #f9fbfd;
    border-radius: 12px;
    box-shadow: 0 2px 16px rgba(25, 103, 210, 0.07);
    overflow: hidden;
    margin-bottom: 24px;
}

.ledger-table thead th {
    background: #e3eafc;
    color: #174ea6;
    font-weight: 700;
    font-size: 16px;
    border-bottom: 2px solid #d1d9e6;
    padding: 16px 12px;
    letter-spacing: 0.02em;
}

.ledger-table tbody tr {
    transition: background 0.18s, box-shadow 0.18s;
    cursor: pointer;
}
.ledger-table tbody tr:hover {
    background: #cedaea;
    box-shadow: 0 2px 8px rgba(25, 103, 210, 0.10);
}
.ledger-table td {
    padding: 14px 12px;
    font-size: 15px;
    border-bottom: 1px solid #e3eafc;
    color: #2d3a4a;
}

.ledger-table td:last-child {
    font-weight: 600;
}

.ledger-table .debit {
    color: #e53935;
    font-weight: 600;
}

.ledger-table .credit {
    color: #21965a;
    font-weight: 600;
}

.ledger-table .balance {
    color: #1967d2;
    font-weight: 700;
}

@media (max-width: 700px) {
    .ledger-table thead th, .ledger-table td {
        padding: 8px 5px;
        font-size: 13px;
    }
}
      .excel-btn {
    background-color: #0d6efd; /* Bootstrap primary blue */
    border-color: #0d6efd;
    font-weight: 600;
    padding: 8px 18px;
    border-radius: 6px;
    transition: 0.2s ease-in-out;
}

.excel-btn:hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
}

.btn-back {
    background-color: #f2f2f2;
    border: 1px solid #ccc;
    color: #333;
    padding: 8px 18px;
    border-radius: 6px;
    font-weight: 500;
    margin-left: 10px;
    transition: 0.2s ease-in-out;
}

.btn-back:hover {
    background-color: #e6e6e6;
    border-color: #bfbfbf;
}
        .spinner {
  margin-left: 5px;
  font-size: 14px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

        /* Notification banner styles */
.notification {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  min-width: 300px;
  max-width: 600px;
  padding: 15px 20px;
  border-radius: 5px;
  color: #fff;
  font-weight: bold;
  font-family: Arial, sans-serif;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 9999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  animation: slideDown 0.5s ease;
}

.notification.success {
  background-color: #28a745; /* green */
}

.notification.error {
  background-color: #dc3545; /* red */
}

.notification .close-btn {
  background: none;
  border: none;
  color: #fff;
  font-size: 18px;
  cursor: pointer;
}

/* Slide-down animation */
@keyframes slideDown {
  from { transform: translate(-50%, -50px); opacity: 0; }
  to { transform: translate(-50%, 0); opacity: 1; }
}

        :root {
            --primary: #1967d2;
            --primary-dark: #174ea6;
            --bg: #f4f8fb;
            --card-bg: #fff;
            --shadow: 0 6px 30px rgba(20,37,63,0.08);
            --table-header: #f2f6fc;
            --green: #21965a;
            --red: #ef5350;
            --font-main: 'Inter', Arial, sans-serif;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg);
            margin: 0;
            min-height: 100vh;
            padding: 0;
        }
        .container {
            max-width: 100%;
            margin: 40px auto;
            background: var(--card-bg);
            border-radius: 18px;
            box-shadow: var(--shadow);
            padding: 32px 32px 24px 32px;
        }
        h2, h3 {
            color: var(--primary-dark);
            font-weight: 600;
            letter-spacing: 0.03em;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--card-bg);
            box-shadow: none;
        }
        th, td {
            padding: 14px 12px;
            text-align: left;
        }
        th {
            background: var(--table-header);
            font-weight: 600;
            border-bottom: 2px solid #e9eef4;
        }
        td {
            border-bottom: 1px solid #eceff1;
            font-size: 16px;
        }
        tr:last-child td {
            border-bottom: none;
        }
        .green { color: var(--green); font-weight: 600; }
        .red { color: var(--red); font-weight: 600; }
        .btn {
          height: 38px;              /* fixed height for all buttons */
          display: inline-flex;
          align-items: center;
          justify-content: center;
          margin-right: 6px;
          padding: 0 18px;           /* consistent padding */
          font-weight: 400px;
          border-radius: 6px;
          font-size: 80%;
          box-sizing: border-box;
        }
        .btn-primary {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 2px 8px rgba(25,103,210,0.06);
        }
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        .btn-danger {
            background: var(--red);
            color: #fff;
        }
        .btn-danger:hover {
            filter: brightness(0.95);
        }
        .btn-back {
            background: #e3e9ef;
            color: var(--primary-dark);
        }
        .btn-back:hover {
            background: #cad6f3;
        }
        .invoice-list {
            margin-top: 24px;
            animation: fadeInUp 0.4s;
        }
        .invoice-item {
            background: #f9fbfe;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 1px 6px rgba(25,103,210,0.04);
            padding: 14px 18px;
            cursor: pointer;
            transition: background 0.14s, box-shadow 0.18s;
            font-size: 15px;
        }
        .invoice-item:hover {
            background: #e5eefc;
            box-shadow: 0 3px 14px rgba(25,103,210,0.09);
        }
        @media (max-width: 700px) {
            .container {
                padding: 16px 4px 10px 4px;
            }
            th, td { padding: 8px 5px; font-size: 14px; }
        }
        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(20px);}
            100% { opacity: 1; transform: none;}
        }
        .btn-home {
    background: #e3e9ef;
    color: #1967d2;
    font-weight: 600;
    border: none;
    margin-right: 10px;
    padding: 8px 16px;
    border-radius: 6px;
    box-shadow: 0 1px 6px rgba(25,103,210,0.05);
    transition: background 0.18s, color 0.18s;
}
.btn-home:hover {
    background: #cad6f3;
    color: #174ea6;
}
/* Modal input styling */
#partyForm input, 
#partyForm textarea {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  margin-bottom: 12px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 14px;
  box-sizing: border-box;
  transition: border-color 0.2s, box-shadow 0.2s;
}

#partyForm input:focus,
#partyForm textarea:focus {
  border-color: #007bff;
  outline: none;
  box-shadow: 0 0 4px rgba(0, 123, 255, 0.3);
}

/* Label spacing */
#partyForm label {
  display: block;
  font-weight: 500;
  color: #333;
  margin-bottom: 6px;
}

/* Textarea resize only vertically */
#partyForm textarea {
  resize: vertical;
  min-height: 60px;
}

.btn.primary {
  background: #007bff;
  color: white;
}

.btn.primary:hover {
  background: #0056b3;
}

.btn.ghost {
  background: transparent;
  border: 1px solid #ccc;
  color: #333;
}

.btn.ghost:hover {
  background: #f0f0f0;
}

/* Actions alignment */
#partyForm .actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}
td[contenteditable="true"] {
  background: #fdfdfd;
  outline: none;
}
td[contenteditable="true"]:focus {
  background: #fff3cd;
}

td > div {
  display: flex;
  align-items: center;
  gap: 8px;
}
 .header-row { display: flex; align-items: center; gap: 18px; margin-bottom: 16px;   justify-content: space-between; }
   
    </style>
</head>
<body>
    <!-- Banner container (fixed at top) -->
<div id="notification" class="notification" style="display:none;">
  <span id="notification-message"></span>
  <button onclick="closeNotification()" class="close-btn">&times;</button>
</div>

<div class="container">
   <div class="header-row">
        <button class="btn btn-home" onclick="goHome()" style="margin-bottom:18px;">
            üè† Home
        </button>
        <h2>Parties</h2>
        <button class="btn btn-primary" onclick="openAddParty()">‚ûï Add Parties</button>    
    </div>
    
   
    <div id="backdrop" style="
        display:none;
        position:fixed; top:0; left:0;
        width:100%; height:100%;
        background:rgba(0,0,0,0.6);
        justify-content:center; align-items:center;
        z-index:9999;
        ">
        <div id="modalContent" style="
            background:#fff; padding:20px; border-radius:12px;
            min-width:300px; max-width:500px; width:90%;
        ">
            <!-- dynamic content will be injected here -->
        </div>
        </div>
    <div class="search-bar" style="margin-bottom:18px;">
        <input type="text" id="partySearchInput" placeholder="Search parties‚Ä¶" style="
        font-size:16px;
        padding:10px 16px;
        border-radius:8px;
        border:1px solid #dee0e3;
        min-width: 260px;
        box-shadow: 0 2px 4px rgba(34,34,34,0.02);
        outline: none;
    ">
    </div>
    <table id="partiesTable">
        <thead>
        <tr>
            <th class="sortable" data-index="0">Name <span></span></th>
            <th class="sortable" data-index="1">Phone <span></span></th>
            <th class="sortable" data-index="3">Address <span></span></th>
            <th class="sortable" data-index="4">GSTIN <span></span></th>
            <th class="sortable" data-index="5">Due Amount <span></span></th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="invoicesContainer" class="invoice-list" style="display:none;">
        <h3 style="display:flex; justify-content:space-between; align-items:center;">
            Invoices for <span id="selectedPartyName"></span>
            <button class="btn btn-add" id="addAmountBtn">
                Add Amount
            </button>
        </h3>
        <div id="invoiceList"></div>
        <button class="btn btn-primary excel-btn" id="exportLedgerBtn" style="display:none; margin-bottom:12px;">
            Export Ledger to Excel
        </button>
        <button class="btn btn-back" onclick="backToParties()">Back to Parties</button>
    </div>
    
</div>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
    let currentParty = null;
    // SEARCH
document.getElementById('partySearchInput').addEventListener('input', function() {
    const filter = this.value.toLowerCase();
    const trs = document.querySelectorAll('#partiesTable tbody tr');
    trs.forEach(tr => {
        const text = tr.textContent.toLowerCase();
        tr.style.display = text.includes(filter) ? '' : 'none';
    });
});
document.getElementById('exportLedgerBtn').addEventListener('click', function () {
    if (!window.currentLedgerInvoices) return;
    // Calculate running balance (oldest to newest)
    const sorted = [...window.currentLedgerInvoices].sort((a, b) => new Date(a.date) - new Date(b.date));
    let balance = 0;
    const wsData = [
        [
            {v: 'Date', s: {font: {bold: true}}},
            {v: 'Invoice #', s: {font: {bold: true}}},
            {v: 'Type', s: {font: {bold: true}}},
            {v: 'Debit (‚Çπ)', s: {font: {bold: true}}},
            {v: 'Credit (‚Çπ)', s: {font: {bold: true}}},
            {v: 'Balance (‚Çπ)', s: {font: {bold: true}}}
        ]
    ];
    sorted.forEach(inv => {
        let debit = 0, credit = 0;
        if (inv.transactionType === 'SELL') {
            debit = inv.totalCost - inv.paidAmount;
            balance += Number(debit);
        } else if (inv.transactionType === 'BUY') {
            credit = inv.totalCost - inv.paidAmount;
            balance -= Number(credit);
        } else if (inv.transactionType === 'CASH') {
            credit = inv.paidAmount;
            balance -= Number(inv.paidAmount);
        }
        wsData.push([
            inv.date,
            inv.invoiceId,
            inv.transactionType,
            debit || '',
            credit || '',
            balance
        ]);
    });
    // Newest first in Excel
    wsData.splice(1, wsData.length - 1, ...wsData.slice(1).reverse());
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ledger");
    const party = document.getElementById('selectedPartyName').textContent || 'Party';
    XLSX.writeFile(wb, `Ledger_${party}.xlsx`);
});
// SORT
document.querySelectorAll('#partiesTable th.sortable').forEach(th => {
    th.addEventListener('click', function() {
        const index = Number(this.getAttribute('data-index'));
        const tbody = th.closest('table').querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const asc = !(this.classList.contains('asc'));
        rows.sort((a, b) => {
            const cellA = a.children[index].innerText.trim().toLowerCase();
            const cellB = b.children[index].innerText.trim().toLowerCase();
            // Numeric sort for Due Amount
            if (index === 4) {
                return asc ? (parseFloat(cellA) - parseFloat(cellB)) : (parseFloat(cellB) - parseFloat(cellA));
            }
            return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
        });
        rows.forEach(row => tbody.appendChild(row));
        // Toggle sort order and arrow
        document.querySelectorAll('#partiesTable th.sortable').forEach(h => {
            h.classList.remove('asc', 'desc');
            h.querySelector('span').textContent = '';
        });
        th.classList.add(asc ? 'asc' : 'desc');
        th.querySelector('span').textContent = asc ? '‚ñ≤' : '‚ñº';
    });
});
let partyList = [];

    async function loadParties() {
      const tbody = document.querySelector('#partiesTable tbody');
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Loading...</td></tr>`;
      try {
        const res = await fetch('/parties');
        if(!res.ok) {
          showNotification("Failed to load parties", 'error');
          return;
        }
        const parties = (await res.json()).data;
        tbody.innerHTML = '';
        partyList = parties;

        if (!parties.length) {
          tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No parties found.</td></tr>`;
          return;
        }

        parties.forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
           <tr data-name="${p.name}"">
            <td contenteditable="true">${p.name}</td>
            <td contenteditable="true">${p.phoneNumber || ''}</td>
            <td contenteditable="true">${p.address || ''}</td>
            <td contenteditable="true">${p.gstin || ''}</td>
            <td contenteditable="false" class="${p.totalDue >= 0 ? 'green' : 'red'}">${p.totalDue || 0}</td>
            <td>
            <div style="display: flex; align-items: center; gap: 8px;">
              <button class="btn btn-primary" 
                      onclick="viewInvoices('${p.name.replace(/'/g,"\\'")}')">
                View Invoices
              </button>

              <button class="btn btn-success save-btn" 
                      style="display: none; height: 38px;" 
                      data-id="${p.partyId}" onclick="saveRow(this)">
                <span class="btn-text">Save</span>
                <span class="spinner" style="display: none;">‚è≥</span>
              </button>

              ${p.totalDue === 0 
                ? `<button class="btn btn-danger" 
                            style="height: 38px;"
                            onclick="deleteRow(this)" 
                            data-id="${p.partyId}" data-due="${p.totalDue}">
                    <span class="btn-text">Delete</span>
                    <span class="spinner" style="display: none;">‚è≥</span>
                  </button>`
                : ''
              }
            </div>

            </td>
            </tr>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Error loading parties: ${err.message}</td></tr>`;
      }
    }
// Ledger format for invoices
function renderLedger(invoices) {
    // Sort oldest to newest for balance calculation
    const sorted = [...invoices].sort((a, b) => parseDMY(a.date) - parseDMY(b.date));
    let balance = 0;
    // Attach running balance to each invoice
    sorted.forEach(inv => {
        let debit = 0, credit = 0;
        if (inv.transactionType === 'SELL') {
            debit = inv.totalCost - inv.paidAmount;
            balance += Number(debit);
        } else if (inv.transactionType === 'BUY') {
            credit = inv.totalCost - inv.paidAmount;
            balance -= Number(credit);
        } else if (inv.transactionType === 'CASH') {
            credit = inv.paidAmount;
            balance -= Number(inv.paidAmount);
        }
        inv._debit = debit || '';
        inv._credit = credit || '';
        inv._balance = balance;
    });

    // Display newest first
    const display = [...sorted].reverse();

    let html = `
        <table class="ledger-table" style="margin-top:16px;">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Invoice #</th>
                    <th>Type</th>
                    <th>Debit (‚Çπ)</th>
                    <th>Credit (‚Çπ)</th>
                    <th>Balance (‚Çπ)</th>
                </tr>
            </thead>
            <tbody>
    `;
    display.forEach(inv => {
        html += `
            <tr onclick="viewInvoicePage(${inv.invoiceId})">
                <td>${inv.date}</td>
                <td>${inv.invoiceId}</td>
                <td>${inv.transactionType}</td>
                <td class="debit">${inv._debit}</td>
                <td class="credit">${inv._credit}</td>
                <td class="balance">${inv._balance}</td>
            </tr>
        `;
    });
    html += '</tbody></table>';
    return html;
}
function parseDMY(dateStr) {
    const [dd, mm, yyyy] = dateStr.split(/[-/]/);
    return new Date(`${yyyy}-${mm}-${dd}`);
}

    async function viewInvoices(partyName) {
    localStorage.setItem('selectedPartyName', partyName); // <-- Add this line
   const partyRow = [...document.querySelectorAll('#partiesTable tbody tr')]
        .find(tr => tr.children[0].innerText === partyName);

    if (partyRow) {
        currentParty = {
            name: partyRow.children[0].innerText,
            phoneNumber: partyRow.children[1].innerText,
            address: partyRow.children[2].innerText,
            gstin: partyRow.children[3].innerText,
            amountAdded: 0 // fallback if missing
        };
    }

    document.getElementById('partiesTable').style.display = 'none';
    document.getElementById('invoicesContainer').style.display = 'block';
    document.getElementById('selectedPartyName').textContent = partyName;

    const listDiv = document.getElementById('invoiceList');
    listDiv.innerHTML = 'Loading...';

    try {
        const invoices = partyList.find(p => p.name === partyName).invoices;
        listDiv.innerHTML = '';

        // In your viewInvoices function, replace the invoice rendering part with:
        if (!invoices.length) {
            listDiv.textContent = 'No invoices found for this party.';
            return;
        }
        listDiv.innerHTML = renderLedger(invoices);
        document.getElementById('exportLedgerBtn').style.display = 'inline-block';
        window.currentLedgerInvoices = invoices; // Save for export
    } catch (err) {
        listDiv.textContent = 'Error loading invoices: ' + err.message;
    }
}

    function backToParties() {
     localStorage.removeItem('selectedPartyName'); // <-- Add this line
     document.getElementById('invoicesContainer').style.display = 'none';
      document.getElementById('exportLedgerBtn').style.display = 'none';
      document.getElementById('partiesTable').style.display = 'table';
    }

    function viewInvoicePage(invoiceId) {
      window.location.href = `/viewSingleInvoice.html?id=${invoiceId}`;
    }

    
window.addEventListener('DOMContentLoaded', async () => {
    await loadParties();
    const persisted = localStorage.getItem('selectedPartyName');
    if (persisted) {
        viewInvoices(persisted);
    }
});
    function goHome() {
    window.location.href = '/index.html';
    }
 
    const showModal = (html) => {
    document.querySelector('#modalContent').innerHTML = html;
    document.querySelector('#backdrop').style.display = 'flex';
  };

  const closeModal = () => {
    document.querySelector('#backdrop').style.display = 'none';
    document.querySelector('#modalContent').innerHTML = '';
  };

  document.querySelector('#backdrop').addEventListener('click', (e) => {
    if (e.target.id === 'backdrop') closeModal();
  });
function showSpinner(btn) {
  const text = btn.querySelector('.btn-text');
  const spinner = btn.querySelector('.spinner');

  text.style.display = 'none';          // hide button text
  spinner.style.display = 'inline-block'; // show spinner
}

function hideSpinner(btn) {
  const text = btn.querySelector('.btn-text');
  const spinner = btn.querySelector('.spinner');

  spinner.style.display = 'none';       // hide spinner
  text.style.display = 'inline';        // show button text
}
  function openAddParty() {
    showModal(`
      <h3>Add Party</h3>
      <form id="partyForm">
        <div class="row">
          <label>Party name<input name="name" required></label>
          <label>Phone<input name="phoneNumber"></label>
          <label>Address<textarea name="address"></textarea></label>
          <label>GSTIN<textarea name="gstin"></textarea></label>
        </div>
        <div class="actions" style="margin-top:15px; display:flex; gap:10px;">
          <button type="button" class="btn ghost" onclick="closeModal()">Cancel</button>
          <button class="btn primary" id="saveBtn">
             <span class="btn-text">Save</span>
            <span class="spinner" style="display:none;">‚è≥</span>
          </button>
        </div>
      </form>
    `);

    document.getElementById('partyForm').addEventListener('submit', async e => {
        const saveBtn = document.getElementById('saveBtn');
        showSpinner(saveBtn);
      e.preventDefault();
      const f = Object.fromEntries(new FormData(e.target));

      const payload = {
        name: f.name,
        phoneNumber: f.phoneNumber,
        address: f.address,
        gstin: f.gstin
      };

      try {
        const res = await fetch('/party/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const msg = await res.text();
          showNotification('Error saving party: ' + msg, 'error');
          return;
        }

        const saved = await res.json();
        
        await loadParties();
        closeModal();
        showNotification('Party saved with ID ' + saved.data, 'success');

      } catch (err) {
        console.error('Save failed', err);
        showNotification('Failed to save party: ' + err.message, 'error');
      } finally {
        hideSpinner(saveBtn);
      }
    });
  }
document.getElementById('addAmountBtn').addEventListener('click', async () => {
    if (!currentParty) {
        showNotification("No party selected.", 'error');
        return;
    }

    const amount = prompt(`Enter amount to add for ${currentParty.name}:`);
    if (!amount || isNaN(amount)) {
        showNotification("Please enter a valid number.", 'error');
        return;
    }

    // update in memory
    currentParty.amountAdded = (currentParty.amountAdded || 0) + Number(amount);
    const payload = {
        partyName: currentParty.name,
        transactionType:"CASH",
        paidAmount: currentParty.amountAdded
    }

    try {
        const res = await fetch('/generateInvoice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            const msg = await res.json().message;
            showNotification('Error saving party: ' + msg, 'error');
            return;
        }

        const saved = await res.json();
        showNotification(`Amount added successfully for ${currentParty.name}!`, 'success');
        await loadParties();
        await viewInvoices(currentParty.name);
    } catch (err) {
        showNotification("Error while saving party: " + err.message, 'error');
    }
});
// Detect changes and show Save button
document.addEventListener("input", function(e) {
  const row = e.target.closest("tr");
  if (!row) return;
  
  const saveBtn = row.querySelector(".save-btn");
  saveBtn.style.display = "inline-block";
});

// Save handler - calls /party/save
async function saveRow(btn) {
  const row = btn.closest("tr");
  const cells = row.querySelectorAll("td[contenteditable='true']");
  const partyId = btn.dataset.id ? parseInt(btn.dataset.id) : null;
  const btnText = btn.querySelector(".btn-text");
  const spinner = btn.querySelector(".spinner");

  // show loader
  btnText.style.display = "none";
  spinner.style.display = "inline-block";
  const updatedParty = {
    partyId: partyId, 
    name: cells[0].innerText.trim(),
    phoneNumber: cells[1].innerText.trim(),
    address: cells[2].innerText.trim(),
    gstin: cells[3].innerText.trim(),
  };

  try {
    const response = await fetch('/party/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updatedParty)
    });

    const data = await response.json();
    if (response.ok) {
      showNotification('Party saved successfully!', 'success');
      // Update row data-partyId if it was a new party
      if (!row.dataset.partyId) row.dataset.partyId = data?.data?.partyId || null;
      btn.style.display = "none"; // hide Save button
    } else {
      showNotification('Error saving party: ' + (data?.message || response.statusText), 'success');
    }
  } catch (err) {
    console.error(err);
    showNotification('Error saving party', 'error');
  } finally {
    // restore button
    btnText.style.display = "inline";
    spinner.style.display = "none";
  }
}

// Delete handler - calls /party/delete
async function deleteRow(btn) {
  const row = btn.closest("tr");
  const partyId = btn.dataset.id ? parseInt(btn.dataset.id) : null;
  const dueAmount = btn.dataset.due ? parseInt(btn.dataset.due) : null;

  if (!partyId) {
    showNotification("PartyId can't be null", 'error');
  }

  if(dueAmount != 0) {
    showNotification("Settle the account first to delete this party", 'error')
  }
const btnText = btn.querySelector(".btn-text");
  const spinner = btn.querySelector(".spinner");

  // Show spinner, hide text
  btnText.style.display = "none";
  spinner.style.display = "inline-block";
  if (!confirm(`Are you sure you want to delete ${row.cells[0].innerText}?`)) return;

  try {
    const response = await fetch(`/party/delete?partyId=${partyId}&dueAmount=${dueAmount}`, {
      method: 'DELETE'
    });

    const data = await response.json();
    if (response.ok) {
      showNotification('Party deleted successfully!', 'success');
      row.remove();
    } else {
      showNotification('Error deleting party: ' + (data?.message || response.statusText), 'error');
    }
  } catch (err) {
    console.error(err);
    showNotification('Error deleting party', 'error');
  }finally {
    // Restore button text
    btnText.style.display = "inline";
    spinner.style.display = "none";
  }
}
// Show notification
function showNotification(message, type = 'success', duration = 3000) {
  const banner = document.getElementById('notification');
  const messageSpan = document.getElementById('notification-message');

  banner.className = `notification ${type}`; // success or error
  messageSpan.innerText = message;
  banner.style.display = 'flex';

  // Auto hide after duration
  setTimeout(() => {
    banner.style.display = 'none';
  }, duration);
}

// Close button
function closeNotification() {
  document.getElementById('notification').style.display = 'none';
}
</script>
</body>
</html>
